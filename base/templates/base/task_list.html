{% extends 'base/main.html' %}
{% block content %}

<div class="header-bar">
    <div>
        <h1>Hello {{ request.user|title }}</h1>
        <h3 style="margin: 0">You have <strong>{{ count }}</strong> incomplete task{{ count|pluralize }}.</h3>
    </div>
{% if request.user.is_authenticated %}
{#<form id="logout-form" method="post" action="{% url 'logout' %}" style="display: none;">#}
{#    {% csrf_token %}#}
{#</form>#}
{#<a href="#" onclick="document.getElementById('logout-form').submit(); return false;">Logout</a>#}
    <a href="{% url 'logout' %}">Logout</a>
{% else %}
    <a href="{% url 'login' %}">Login</a>
{#{% else %}#}
{#<a href="{% url 'login' %}">Login</a>#}
{% endif %}
</div>

<div id="search-add-wrapper">
    <form action="" method="GET" style="margin-top: 20px; margin-bottom: 20px; display: flex;">
        <input type="text" name="search-area" value="{{ search_input }}">
        <input class="button" type="submit" value="search">
    </form>
    <a id="add-link" href="{% url 'task-create' %}">&#x2b;</a>
</div>

<div class="task-items-wrapper">
    {% for task in object_list %}
        <div class="task-wrapper">
            <button class="circle-btn" data-id="{{ task.id }}">
                {% if task.complete %}
                    <div class="task-complete-icon"></div>
                {% else %}
                    <div class="task-incomplete-icon"></div>
                {% endif %}
            </button>
        <div class="task-title {% if task.complete %}line-through{% endif %}">
            <a href="{% url 'task-update' task.id %}">{{ task }}</a>
        </div>
    <a class="delete-link" href="{% url 'task-delete' task.id %}">&#215;</a>
</div>

    {% empty %}
    <h3>No Items in List</h3>
    {% endfor %}
</div>


<script>
function getCookie(name) {
    let cookieValue = null;
    if (document.cookie && document.cookie !== "") {
        const cookies = document.cookie.split(";");
        for (let i = 0; i < cookies.length; i++) {
            const cookie = cookies[i].trim();
            if (cookie.substring(0, name.length + 1) === (name + "=")) {
                cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                break;
            }
        }
    }
    return cookieValue;
}

document.querySelectorAll(".circle-btn").forEach(button => {
    button.addEventListener("click", function() {
        const taskId = this.getAttribute("data-id");

        fetch(`/task/${taskId}/toggle/`, {
            method: "POST",
            headers: {
                "X-CSRFToken": getCookie("csrftoken"),
            },
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                const parent = this.parentElement;
                const title = parent.querySelector(".task-title");

                if (data.complete) {
                    this.innerHTML = '<div class="task-complete-icon"></div>';
                    title.classList.add("line-through");
                } else {
                    this.innerHTML = '<div class="task-incomplete-icon"></div>';
                    title.classList.remove("line-through");
                }

                // ðŸ”¹ Ø¢Ù¾Ø¯ÛŒØª Ø´Ù…Ø§Ø±Ù†Ø¯Ù‡
                const counter = document.querySelector("h3 strong");
                if (counter && data.incomplete_count !== undefined) {
                    counter.innerText = data.incomplete_count;
                }
            }
        });
    });
});
</script>

{% endblock content%}